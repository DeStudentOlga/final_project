# Проект «Банковские операции»
## Требования к проекту (техническое задание)
Имеются данные о банковских операциях (100000 записей), сведения о счетах (20000 записей), сведения о клиентах (10000 записей), а также данные о курсах валют по отношению к рублю. Данные имеют следующую структуру.
<li>Операции по счетам</li>
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224079189-5bdacc64-3f97-467b-afeb-1364bcf9c06e.png">
<li>Клиенты</li>
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224077973-33ebfa8e-5407-45e2-adb0-3b87da81b840.png">
<li>Счета</li>
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224079962-4b9965b1-7520-4c9a-a7b5-ac604d6e13aa.png">
<li>Курсы валют по отношению к рублю</li>
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224080411-0dc211a9-c176-407f-8249-80f247fd5d42.png">
Требуется разработать три витрины данных: corporate_payments, corporate_account, corporate_info. Суммы должны быть в национальной валюте, для перевода использовать актуальный курс из таблицы курсов. Из каждой витрины необходимо сформировать патриции по датам совершения операций 2020-11-01, 2020-11-02, 2020-11-03, 2020-11-04 и сохранить в формате parquet.
<br>
<br><b>Описание витрин данных</b>
<br><li>Витрина corporate_payments </li>
Строится по каждому уникальному счету (AccountDB  и AccountCR) из таблицы Operation. Ключ партиции CutoffDt.
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224082683-34e80cc1-5916-404e-8ef2-e96b1af14eb1.png">
<li>Витрина corporate_account </li>
Строится по каждому уникальному счету из таблицы Operation на заданную дату расчета. Ключ партиции CutoffDt.
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224082943-e6d552b2-1abe-4e59-b347-522084e8b393.png">
<li>Витрина corporate_info</li>
Строится по каждому уникальному клиенту из таблицы Operation. 
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224083029-e5ec424b-f870-435d-b632-eab3284a959e.png">

## Исходные данные
Данные о клиентах представлены в файле Clients.csv
<br>Данные о счетах клиентов – в файле Account.csv
<br>Данные о совершенных банковских транзакциях – в файле Operation.csv
<br>Данные о курсах валют – в файле Rate.csv
<br>Перечисленные файлы загружены в папку Data проекта.

Также имеется два списка масок слов, по назначениям платежа
<br><I>Список 1 (авто):</I>
<br>%а/м%, %а\м%, %автомобиль %, %автомобили %, %транспорт%, %трансп%средс%, %легков%, %тягач%, %вин%, %vin%,%viн:%, %fоrd%, %форд%,%кiа%, %кия%, %киа%%мiтsuвisнi%, %мицубиси%, %нissан%, %ниссан%, %sсанiа%, %вмw%, %бмв%, %аudi%, %ауди%, %jеер%, %джип%, %vоlvо%, %вольво%, %тоyота%, %тойота%, %тоиота%, %нyuнdаi%, %хендай%, %rенаulт%, %рено%, %реugеот%, %пежо%, %lаdа%, %лада%, %dатsuн%, %додж%, %меrсеdеs%, %мерседес%, %vоlкswаgен%, %фольксваген%, %sкоdа%, %шкода%, %самосвал%, %rover%, %ровер%
<br><I>Список 2 (продукты питания):</I>
<br>%сою%, %соя%, %зерно%, %кукуруз%, %масло%, %молок%, %молоч%, %мясн%, %мясо%, %овощ%, %подсолн%, %пшениц%, %рис%, %с/х%прод%, %с/х%товар%, %с\х%прод%, %с\х%товар%, %сахар%, %сельск%прод%, %сельск%товар%, %сельхоз%прод%, %сельхоз%товар%, %семен%, %семечк%, %сено%, %соев%, %фрукт%, %яиц%, %ячмен%, %картоф%, %томат%, %говя%, %свин%, %курин%, %куриц%, %рыб%, %алко%, %чаи%, %кофе%, %чипс%, %напит%, %бакале%, %конфет%, %колбас%, %морож%, %с/м%, %с\м%, %консерв%, %пищев%, %питан%, %сыр%, %макарон%, %лосос%, %треск%, %саир%, % филе%, % хек%, %хлеб%, %какао%, %кондитер%, %пиво%, %ликер%
## Используемые технологии
<I>SQL</I> 
<br>В качестве СУБД выбрана PostgreSQL, open source решение с возможностями хорошей промышленной СУБД. Поддерживает большинство функций в соответствие со стандартом SQL 2016, включает множество удобных расширений. Позволяет упрощать написание запросов и оптимизировать их выполнение использования общих табличных выражений. Позволяет сохранять результаты запросов в виде представлений (View).  Оптимизатор запросов, поддержка разнообразных индексов и партицирования позволяет работать с большими объемами данных. Следует отметить удобство миграции на СУБД GrinPlam с MPP архитектурой.
<I>Spark</I>
<br>Выбран PySpark, позволяющий работать с фреймворком Apache Spark. Удобно устанавливать в связке с Jupyter Notebook.
## Схема данных
<img width="500" alt="image" src="https://user-images.githubusercontent.com/118614238/224090248-b7dd124d-f5b7-4f3e-a41f-dce08328aca0.png">

## Алгоритм реализации
<ol>1.	Разработка базы данных (БД), преобразование и загрузка данных в БД.</ol>
<p>Вариант a. База данных создается с помощью sql запросов на стороне СУБД. Данные загружаются из csv файлов в разработанные таблицы БД. Выполняется необходимое преобразование данных и таблиц: замена разделителя десятичных разрядов и преобразование типов данных в соответствующих атрибутах. Пример реализации такого варианта для данных о клиентах, счетах, операциях и курсах валют приведен в файле сreateBD.sql.</p>
<p>Вариант b. Возможна загрузка данных в скрипт Python, выполнение необходимых преобразований, а затем создание и заполнение таблиц через подключение к БД с помощью методов, реализованных в PySpark. Пример реализации такого подхода для данных о масках слов приведен в файле create_lists.ipynb.</p>
<ol>2.	Разработка витрин данных.</ol>
<p>Создание необходимых представлений (view) в PostgreSQL. Предварительно разработаны вспомогательные представления для дебетовых (dbt View) и кредитовых транзакций (crt View). Далее на их основе разработано представление corporate_payments, где использованы общие табличные выражения, оконные функции с фильтрами, различные операторы объединения, фильтрация данных, в том числе с использованием вложенных запросов нескалярного типа. Итоговый код представлен в файле views.sql.</p>
<br>
<ol>3.	Партицирование витрин по датам и сохранение каждой витрины за определенную дату в файл формата parquet.</ol>
<p>Выполнено с помощью pyspark. Код – в файле project4.ipynb.</p>

## Результаты

<li>Витрина corporate_payments (фрагмент)</li>
<img width="468" alt="image" src="https://user-images.githubusercontent.com/118614238/224096657-e5d497d8-47e4-4d08-bea5-8a4df83c86cf.png">
<li>Витрина corporate_account (фрагмент)</li>
<img width="468" alt="image" src="https://user-images.githubusercontent.com/118614238/224096494-b12d9544-dfb6-4c06-a15a-b6363ec42fea.png">
<li>Витрина corporate_info (фрагмент)</li>
<img width="468" alt="image" src="https://user-images.githubusercontent.com/118614238/224096264-6b8958d6-49e4-4157-9f06-d8742cd9029a.png">
<li>Вывод витрины corporate_payments на 2022-11-01 из parquet файла (фрагмент)</li>
<img width="441" alt="image" src="https://user-images.githubusercontent.com/118614238/224096124-286b4271-ae35-4f2c-9169-1b9ad3963e5f.png">
<li>Вывод витрины corporate_account на 2022-11-01 из parquet файла (фрагмент)</li>
<img width="384" alt="image" src="https://user-images.githubusercontent.com/118614238/224095967-d9aca45c-7a4a-4462-94c3-7ebb958afc2c.png">
<li>Вывод витрины corporate_info на 2022-11-01 из parquet файла (фрагмент)</li>
<img width="373" alt="image" src="https://user-images.githubusercontent.com/118614238/224095803-d254362c-8966-474e-8a75-90632a2151a6.png">

## Выводы
Разработано три витрины данных corporate_payments, corporate_account, corporate_info. 
При имеющемся объеме данных время выполнения запросов по формированию каждой из витрин в PostgreSQL не превышает 2 с, что является приемлемым.
Партицирование витрин по дате совершения операции с сохранением в parquet формат и последующий вывод витрин на заданные даты происходит без задержек.
